<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>测试视频监控</title>
    <script src="jquery.js"></script>
    <script>
        let webrtc, webrtcSendChannel;
        let mediaStream;

        $(document).ready(() => {
            startPlay();
        });

        async function startPlay() {
            mediaStream = new MediaStream();
            $("#videoPlayer")[0].srcObject =  mediaStream;
            webrtc = new RTCPeerConnection({
                iceServers: [{
                    urls: ["stun:stun.l.google.com:19302"]
                }],
                sdpSemantics: "unified-plan"
            });
            webrtc.onnegotiationneeded = handleNegotiationNeeded;
            webrtc.onsignalingstatechange = signalingstatechange;

            webrtc.ontrack = ontrack
            let offer = await webrtc.createOffer({
                //iceRestart:true,
                offerToReceiveAudio:true,
                offerToReceiveVideo:true
            });
            await webrtc.setLocalDescription(offer);
        }

        function ontrack (event){
            console.log(event.streams.length + ' track is delivered');
            mediaStream.addTrack(event.track);
        }

        async function signalingstatechange (){
            switch (webrtc.signalingState){
                case 'have-local-offer':
                    let uuid = 'dating'
                    let channel = '0';
                    let url = "http://localhost:8083" + "/stream/" + uuid + "/channel/" + channel + "/webrtc?uuid=" + uuid + '&channel=' + channel;
                    $.post(url, {
                        data: btoa(webrtc.localDescription.sdp)
                    }, function(data) {
                        try {
                            console.log(data);
                            webrtc.setRemoteDescription(new RTCSessionDescription({
                                type: 'answer',
                                sdp: atob(data)
                            }))
                        } catch (e) {
                            console.warn(e);
                        }

                    });
                    break;
                case 'stable':
                    /*
                    * There is no ongoing exchange of offer and answer underway.
                    * This may mean that the RTCPeerConnection object is new, in which case both the localDescription and remoteDescription are null;
                    * it may also mean that negotiation is complete and a connection has been established.
                    */
                    break;

                case 'closed':
                    /*
                     * The RTCPeerConnection has been closed.
                     */
                    break;

                default:
                    console.log(`unhandled signalingState is ${webrtc.signalingState}`);
                    break;
            }
        }

        async function handleNegotiationNeeded() {
            let uuid = 'dating'
            let channel = '0';
            let url = "http://localhost:8083" + "/stream/" + uuid + "/channel/" + channel + "/webrtc?uuid=" + uuid + '&channel=' + channel;
            let offer = await webrtc.createOffer();

            await webrtc.setLocalDescription(offer);
            $.post(url, {
                data: btoa(webrtc.localDescription.sdp)
            }, function(data) {
                try {
                    console.log(data);
                    webrtc.setRemoteDescription(new RTCSessionDescription({
                        type: 'answer',
                        sdp: atob(data)
                    }))
                } catch (e) {
                    console.warn(e);
                }

            });
        }

        $("#videoPlayer")[0].addEventListener('loadeddata', () => {
            $("#videoPlayer")[0].play();
            makePic();
        });

        $("#videoPlayer")[0].addEventListener('error', () => {
            console.log('video_error')
        });
    </script>
</head>
<body>
  <div style="width: 800px;height: 600px;">
    <video id="videoPlayer" autoplay controls muted playsinline></video>
    <canvas id="canvas" class="d-none"></canvas>
  </div>
</body>
</html>